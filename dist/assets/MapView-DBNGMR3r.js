import{r as a,j as s}from"./index-DgwRJj1l.js";import{L as O}from"./maps-93e-Jyro.js";import"./vendor-Bzgz95E1.js";import"./firebase-BnRZRRKd.js";const B="AIzaSyAylaaHTNErQ5xi0wXs0IHtTPunSKOvAHg",F=()=>s.jsx("div",{className:"map-loader",children:s.jsx("div",{className:"loading-spinner"})}),T=({message:p})=>s.jsx("div",{className:"map-error-overlay",children:s.jsx("p",{children:p})}),J=({onStartAudit:p})=>{const[K,I]=a.useState(!1),[b,R]=a.useState(null),[M,m]=a.useState(!0),[u,v]=a.useState([]),[j,h]=a.useState(!1),f=a.useRef(null),c=a.useRef(null),n=a.useRef(null),g=a.useRef(null),i=a.useRef(null),d=a.useRef([]),x="smartlocal-map-search-history",L=10;a.useEffect(()=>{try{const t=localStorage.getItem(x);t&&v(JSON.parse(t))}catch(t){console.error("Failed to parse search history from localStorage",t)}},[]),a.useEffect(()=>{new O({apiKey:B,version:"weekly",libraries:["places","marker"]}).load().then(r=>{I(!0),C(r)}).catch(r=>{console.error("Failed to load Google Maps script:",r),R("Failed to load Google Maps. Please check that the API key is correct and has the 'Maps JavaScript API' and 'Places API' enabled.")}).finally(()=>{m(!1)})},[]);const A=t=>{if(!t||!t.trim())return;const r=t.trim(),e=[r,...u.filter(o=>o.toLowerCase()!==r.toLowerCase())].slice(0,L);v(e);try{localStorage.setItem(x,JSON.stringify(e))}catch(o){console.error("Failed to save search history to localStorage",o)}},N=()=>{u.length>0&&h(!0)},E=()=>{setTimeout(()=>h(!1),150)},P=t=>{c.current&&(c.current.value=t,y({query:t}))},H=t=>{d.current.forEach(e=>e.setMap(null)),d.current=[];const r=new google.maps.LatLngBounds;t.forEach(e=>{if(!e.geometry||!e.geometry.location||!e.name)return;const o=new google.maps.Marker({map:n.current,position:e.geometry.location,title:e.name,animation:google.maps.Animation.DROP,icon:"https://maps.google.com/mapfiles/ms/icons/green-dot.png"});o.addListener("click",()=>{if(!i.current)return;const l=e.website??"",S=encodeURIComponent(e.name),w=encodeURIComponent(l),_=`
                    <div class="map-infowindow-content">
                        <h4>${e.name}</h4>
                        <p>${e.formatted_address||""}</p>
                        <div class="map-infowindow-buttons" style="margin-top: 1rem;">
                            <button class="btn btn-primary btn-start-audit" data-name="${S}" data-website="${w}">Start an audit</button>
                        </div>
                    </div>
                `;i.current.setContent(_),i.current.open(n.current,o)}),d.current.push(o),r.extend(e.geometry.location)}),n.current&&d.current.length>0&&n.current.fitBounds(r)},C=t=>{if(!f.current||!c.current)return;n.current=new t.maps.Map(f.current,{center:{lat:34.0522,lng:-118.2437},zoom:12,mapId:"SMART_LOCAL_AI_MAP"}),g.current=new t.maps.places.PlacesService(n.current),i.current=new t.maps.InfoWindow;const r=new t.maps.places.Autocomplete(c.current,{fields:["geometry","name","website"]});r.addListener("place_changed",()=>{const e=r.getPlace();e.geometry&&e.geometry.location&&(n.current?.setCenter(e.geometry.location),n.current?.setZoom(15),e.name&&(A(e.name),y({location:e.geometry.location,radius:2e3,query:e.name})))}),i.current.addListener("domready",()=>{document.querySelectorAll(".btn-start-audit").forEach(o=>{const l=o;l.addEventListener("click",()=>{const S=decodeURIComponent(l.getAttribute("data-name")||""),w=decodeURIComponent(l.getAttribute("data-website")||"");p({name:S,website:w||void 0})})})}),m(!1)},y=t=>{g.current&&(m(!0),g.current.textSearch(t,(r,e)=>{m(!1),e===google.maps.places.PlacesServiceStatus.OK&&r?H(r):console.warn("Places search failed with status:",e)}))},k=t=>{t.preventDefault();const r=c.current?.value?.trim();if(!r)return;A(r),h(!1);const e=n.current?.getCenter()||new google.maps.LatLng(34.0522,-118.2437);y({location:e,radius:1e4,query:r})};return b?s.jsx(T,{message:b}):s.jsxs("div",{className:"map-view",children:[M&&s.jsx(F,{}),s.jsxs("div",{className:"map-search-container",children:[s.jsxs("form",{onSubmit:k,className:"map-search-form",children:[s.jsx("input",{ref:c,type:"text",className:"map-search-input",placeholder:"Search for businesses...",onFocus:N,onBlur:E}),s.jsx("button",{type:"submit",className:"map-search-button",children:"Search"})]}),j&&u.length>0&&s.jsx("div",{className:"map-search-history",children:u.map((t,r)=>s.jsx("div",{className:"map-search-history-item",onMouseDown:()=>P(t),children:t},r))})]}),s.jsx("div",{ref:f,className:"map-container"})]})};export{J as MapView};
